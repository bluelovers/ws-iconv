"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const fs = require("fs");
const internal_1 = require("./lib/internal");
const internal = require("./lib/internal");
const read_1 = require("./read");
exports.kMinPoolSpace = 128;
let pool;
const poolFragments = [];
function allocNewPool(poolSize) {
    if (poolFragments.length > 0) {
        pool = poolFragments.pop();
    }
    else {
        pool = Buffer.allocUnsafe(poolSize);
    }
    pool.used = 0;
}
class SyncReadStream extends read_1.ReadStream {
    constructor(path, options) {
        // @ts-ignore
        super(path, options);
    }
    static get create() {
        return createSyncReadStream;
    }
    open() {
        if (typeof internal_1.getFsStreamData(this) !== 'boolean') {
            this[internal_1.SYM_FS_STREAM_DATA].opened = true;
            internal.open(this);
            this.read();
        }
        else if (this[internal_1.SYM_FS_STREAM_DATA].opened === true) {
            this[internal_1.SYM_FS_STREAM_DATA].opened = false;
            this.emit('open', this.fd);
            this.emit('ready');
        }
    }
    _read(n) {
        if (typeof this.fd !== 'number') {
            return this.once('open', function () {
                this._read(n);
            });
        }
        if (this.destroyed) {
            return;
        }
        if (!pool || pool.length - pool.used < exports.kMinPoolSpace) {
            // discard the old pool.
            allocNewPool(this.readableHighWaterMark);
        }
        const thisPool = pool;
        let toRead = Math.min(pool.length - pool.used, n);
        const start = pool.used;
        if (this.pos !== undefined) {
            toRead = Math.min(this.end - this.pos + 1, toRead);
        }
        else {
            toRead = Math.min(this.end - this.bytesRead + 1, toRead);
        }
        // already read everything we were supposed to read!
        // treat as EOF.
        if (toRead <= 0) {
            return this.push(null);
        }
        try {
            // the actual read.
            let bytesRead = fs.readSync(this.fd, pool, pool.used, toRead, this.pos);
            let b = null;
            // Now that we know how much data we have actually read, re-wind the
            // 'used' field if we can, and otherwise allow the remainder of our
            // reservation to be used as a new pool later.
            if (start + toRead === thisPool.used && thisPool === pool) {
                thisPool.used += bytesRead - toRead;
            }
            else if (toRead - bytesRead > exports.kMinPoolSpace) {
                poolFragments.push(thisPool.slice(start + bytesRead, start + toRead));
            }
            if (bytesRead > 0) {
                this.bytesRead += bytesRead;
                b = thisPool.slice(start, start + bytesRead);
            }
            this.push(b);
        }
        catch (er) {
            if (this.autoClose) {
                this.destroy();
            }
            this.emit('error', er);
        }
        // move the pool positions, and internal position for reading.
        if (this.pos !== undefined) {
            this.pos += toRead;
        }
        pool.used += toRead;
    }
    _destroy(error, callback) {
        internal._destroy(this, error, callback);
    }
}
exports.SyncReadStream = SyncReadStream;
function createSyncReadStream(path, options) {
    return new SyncReadStream(path, options);
}
exports.createSyncReadStream = createSyncReadStream;
exports.default = SyncReadStream;
// @ts-ignore
Object.freeze(exports);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVhZC1zeW5jLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicmVhZC1zeW5jLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEseUJBQTBCO0FBRzFCLDZDQUFxRTtBQUNyRSwyQ0FBNEM7QUFDNUMsaUNBQW1DO0FBRXRCLFFBQUEsYUFBYSxHQUFHLEdBQUcsQ0FBQztBQUNqQyxJQUFJLElBQUksQ0FBQztBQUNULE1BQU0sYUFBYSxHQUFHLEVBQUUsQ0FBQztBQUV6QixTQUFTLFlBQVksQ0FBQyxRQUFnQjtJQUVyQyxJQUFJLGFBQWEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUM1QjtRQUNDLElBQUksR0FBRyxhQUFhLENBQUMsR0FBRyxFQUFFLENBQUM7S0FDM0I7U0FFRDtRQUNDLElBQUksR0FBRyxNQUFNLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0tBQ3BDO0lBQ0QsSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDLENBQUM7QUFDZixDQUFDO0FBRUQsTUFBYSxjQUFlLFNBQVEsaUJBQVU7SUFFN0MsWUFBWSxJQUFjLEVBQUUsT0FBdUM7UUFFbEUsYUFBYTtRQUNiLEtBQUssQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUE7SUFDckIsQ0FBQztJQUVELE1BQU0sS0FBSyxNQUFNO1FBRWhCLE9BQU8sb0JBQW9CLENBQUE7SUFDNUIsQ0FBQztJQUVELElBQUk7UUFFSCxJQUFJLE9BQU8sMEJBQWUsQ0FBQyxJQUFJLENBQUMsS0FBSyxTQUFTLEVBQzlDO1lBQ0MsSUFBSSxDQUFDLDZCQUFrQixDQUFDLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQTtZQUN0QyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1lBQ25CLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztTQUNaO2FBQ0ksSUFBSSxJQUFJLENBQUMsNkJBQWtCLENBQUMsQ0FBQyxNQUFNLEtBQUssSUFBSSxFQUNqRDtZQUNDLElBQUksQ0FBQyw2QkFBa0IsQ0FB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Q0QsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLENBQUM7U0FDdkI7UUFFRCw4REFBOEQ7UUFDOUQsSUFBSSxJQUFJLENBQUMsR0FBRyxLQUFLLFNBQVMsRUFDMUI7WUFDQyxJQUFJLENBQUMsR0FBRyxJQUFJLE1BQU0sQ0FBQztTQUNuQjtRQUNELElBQUksQ0FBQyxJQUFJLElBQUksTUFBTSxDQUFDO0lBQ3JCLENBQUM7SUFFRCxRQUFRLENBQUMsS0FBbUIsRUFBRSxRQUF1QztRQUVwRSxRQUFRLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsUUFBUSxDQUFDLENBQUE7SUFDekMsQ0FBQztDQUNEO0FBckhELHdDQXFIQztBQUVELFNBQWdCLG9CQUFvQixDQUFDLElBQWMsRUFBRSxPQUF1QztJQUUzRixPQUFPLElBQUksY0FBYyxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQTtBQUN6QyxDQUFDO0FBSEQsb0RBR0M7QUFFRCxrQkFBZSxjQUFjLENBQUE7QUFDN0IsYUFBYTtBQUNiLE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZnMgPSByZXF1aXJlKCdmcycpO1xuaW1wb3J0IHsgUGF0aExpa2UgfSBmcm9tIFwiZnNcIjtcbmltcG9ydCB7IElGc1JlYWRTdHJlYW1PcHRpb25zIH0gZnJvbSAnLi9saWIvaW50ZXJmYWNlJztcbmltcG9ydCB7IGdldEZzU3RyZWFtRGF0YSwgU1lNX0ZTX1NUUkVBTV9EQVRBIH0gZnJvbSAnLi9saWIvaW50ZXJuYWwnO1xuaW1wb3J0IGludGVybmFsID0gcmVxdWlyZShcIi4vbGliL2ludGVybmFsXCIpO1xuaW1wb3J0IHsgUmVhZFN0cmVhbSB9IGZyb20gJy4vcmVhZCdcblxuZXhwb3J0IGNvbnN0IGtNaW5Qb29sU3BhY2UgPSAxMjg7XG5sZXQgcG9vbDtcbmNvbnN0IHBvb2xGcmFnbWVudHMgPSBbXTtcblxuZnVuY3Rpb24gYWxsb2NOZXdQb29sKHBvb2xTaXplOiBudW1iZXIpXG57XG5cdGlmIChwb29sRnJhZ21lbnRzLmxlbmd0aCA+IDApXG5cdHtcblx0XHRwb29sID0gcG9vbEZyYWdtZW50cy5wb3AoKTtcblx0fVxuXHRlbHNlXG5cdHtcblx0XHRwb29sID0gQnVmZmVyLmFsbG9jVW5zYWZlKHBvb2xTaXplKTtcblx0fVxuXHRwb29sLnVzZWQgPSAwO1xufVxuXG5leHBvcnQgY2xhc3MgU3luY1JlYWRTdHJlYW0gZXh0ZW5kcyBSZWFkU3RyZWFtXG57XG5cdGNvbnN0cnVjdG9yKHBhdGg6IFBhdGhMaWtlLCBvcHRpb25zPzogc3RyaW5nIHwgSUZzUmVhZFN0cmVhbU9wdGlvbnMpXG5cdHtcblx0XHQvLyBAdHMtaWdub3JlXG5cdFx0c3VwZXIocGF0aCwgb3B0aW9ucylcblx0fVxuXG5cdHN0YXRpYyBnZXQgY3JlYXRlKClcblx0e1xuXHRcdHJldHVybiBjcmVhdGVTeW5jUmVhZFN0cmVhbVxuXHR9XG5cblx0b3BlbigpOiB2b2lkXG5cdHtcblx0XHRpZiAodHlwZW9mIGdldEZzU3RyZWFtRGF0YSh0aGlzKSAhPT0gJ2Jvb2xlYW4nKVxuXHRcdHtcblx0XHRcdHRoaXNbU1lNX0ZTX1NUUkVBTV9EQVRBXS5vcGVuZWQgPSB0cnVlXG5cdFx0XHRpbnRlcm5hbC5vcGVuKHRoaXMpXG5cdFx0XHR0aGlzLnJlYWQoKTtcblx0XHR9XG5cdFx0ZWxzZSBpZiAodGhpc1tTWU1fRlNfU1RSRUFNX0RBVEFdLm9wZW5lZCA9PT0gdHJ1ZSlcblx0XHR7XG5cdFx0XHR0aGlzW1NZTV9GU19TVFJFQU1fREFUQV0ub3BlbmVkID0gZmFsc2Vcblx0XHRcdHRoaXMuZW1pdCgnb3BlbicsIHRoaXMuZmQpO1xuXHRcdFx0dGhpcy5lbWl0KCdyZWFkeScpO1xuXHRcdH1cblx0fVxuXG5cdF9yZWFkKG46IG51bWJlcilcblx0e1xuXHRcdGlmICh0eXBlb2YgdGhpcy5mZCAhPT0gJ251bWJlcicpXG5cdFx0e1xuXHRcdFx0cmV0dXJuIHRoaXMub25jZSgnb3BlbicsIGZ1bmN0aW9uICgpXG5cdFx0XHR7XG5cdFx0XHRcdHRoaXMuX3JlYWQobik7XG5cdFx0XHR9KTtcblx0XHR9XG5cblx0XHRpZiAodGhpcy5kZXN0cm95ZWQpXG5cdFx0e1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdGlmICghcG9vbCB8fCBwb29sLmxlbmd0aCAtIHBvb2wudXNlZCA8IGtNaW5Qb29sU3BhY2UpXG5cdFx0e1xuXHRcdFx0Ly8gZGlzY2FyZCB0aGUgb2xkIHBvb2wuXG5cdFx0XHRhbGxvY05ld1Bvb2wodGhpcy5yZWFkYWJsZUhpZ2hXYXRlck1hcmspO1xuXHRcdH1cblxuXHRcdGNvbnN0IHRoaXNQb29sID0gcG9vbDtcblx0XHRsZXQgdG9SZWFkID0gTWF0aC5taW4ocG9vbC5sZW5ndGggLSBwb29sLnVzZWQsIG4pO1xuXHRcdGNvbnN0IHN0YXJ0ID0gcG9vbC51c2VkO1xuXG5cdFx0aWYgKHRoaXMucG9zICE9PSB1bmRlZmluZWQpXG5cdFx0e1xuXHRcdFx0dG9SZWFkID0gTWF0aC5taW4odGhpcy5lbmQgLSB0aGlzLnBvcyArIDEsIHRvUmVhZCk7XG5cdFx0fVxuXHRcdGVsc2Vcblx0XHR7XG5cdFx0XHR0b1JlYWQgPSBNYXRoLm1pbih0aGlzLmVuZCAtIHRoaXMuYnl0ZXNSZWFkICsgMSwgdG9SZWFkKTtcblx0XHR9XG5cblx0XHQvLyBhbHJlYWR5IHJlYWQgZXZlcnl0aGluZyB3ZSB3ZXJlIHN1cHBvc2VkIHRvIHJlYWQhXG5cdFx0Ly8gdHJlYXQgYXMgRU9GLlxuXHRcdGlmICh0b1JlYWQgPD0gMClcblx0XHR7XG5cdFx0XHRyZXR1cm4gdGhpcy5wdXNoKG51bGwpO1xuXHRcdH1cblxuXHRcdHRyeVxuXHRcdHtcblx0XHRcdC8vIHRoZSBhY3R1YWwgcmVhZC5cblx0XHRcdGxldCBieXRlc1JlYWQgPSBmcy5yZWFkU3luYyh0aGlzLmZkLCBwb29sLCBwb29sLnVzZWQsIHRvUmVhZCwgdGhpcy5wb3MpO1xuXG5cdFx0XHRsZXQgYiA9IG51bGw7XG5cdFx0XHQvLyBOb3cgdGhhdCB3ZSBrbm93IGhvdyBtdWNoIGRhdGEgd2UgaGF2ZSBhY3R1YWxseSByZWFkLCByZS13aW5kIHRoZVxuXHRcdFx0Ly8gJ3VzZWQnIGZpZWxkIGlmIHdlIGNhbiwgYW5kIG90aGVyd2lzZSBhbGxvdyB0aGUgcmVtYWluZGVyIG9mIG91clxuXHRcdFx0Ly8gcmVzZXJ2YXRpb24gdG8gYmUgdXNlZCBhcyBhIG5ldyBwb29sIGxhdGVyLlxuXHRcdFx0aWYgKHN0YXJ0ICsgdG9SZWFkID09PSB0aGlzUG9vbC51c2VkICYmIHRoaXNQb29sID09PSBwb29sKVxuXHRcdFx0e1xuXHRcdFx0XHR0aGlzUG9vbC51c2VkICs9IGJ5dGVzUmVhZCAtIHRvUmVhZDtcblx0XHRcdH1cblx0XHRcdGVsc2UgaWYgKHRvUmVhZCAtIGJ5dGVzUmVhZCA+IGtNaW5Qb29sU3BhY2UpXG5cdFx0XHR7XG5cdFx0XHRcdHBvb2xGcmFnbWVudHMucHVzaCh0aGlzUG9vbC5zbGljZShzdGFydCArIGJ5dGVzUmVhZCwgc3RhcnQgKyB0b1JlYWQpKTtcblx0XHRcdH1cblxuXHRcdFx0aWYgKGJ5dGVzUmVhZCA+IDApXG5cdFx0XHR7XG5cdFx0XHRcdHRoaXMuYnl0ZXNSZWFkICs9IGJ5dGVzUmVhZDtcblx0XHRcdFx0YiA9IHRoaXNQb29sLnNsaWNlKHN0YXJ0LCBzdGFydCArIGJ5dGVzUmVhZCk7XG5cdFx0XHR9XG5cblx0XHRcdHRoaXMucHVzaChiKTtcblx0XHR9XG5cdFx0Y2F0Y2ggKGVyKVxuXHRcdHtcblx0XHRcdGlmICh0aGlzLmF1dG9DbG9zZSlcblx0XHRcdHtcblx0XHRcdFx0dGhpcy5kZXN0cm95KCk7XG5cdFx0XHR9XG5cdFx0XHR0aGlzLmVtaXQoJ2Vycm9yJywgZXIpO1xuXHRcdH1cblxuXHRcdC8vIG1vdmUgdGhlIHBvb2wgcG9zaXRpb25zLCBhbmQgaW50ZXJuYWwgcG9zaXRpb24gZm9yIHJlYWRpbmcuXG5cdFx0aWYgKHRoaXMucG9zICE9PSB1bmRlZmluZWQpXG5cdFx0e1xuXHRcdFx0dGhpcy5wb3MgKz0gdG9SZWFkO1xuXHRcdH1cblx0XHRwb29sLnVzZWQgKz0gdG9SZWFkO1xuXHR9XG5cblx0X2Rlc3Ryb3koZXJyb3I6IEVycm9yIHwgbnVsbCwgY2FsbGJhY2s6IChlcnJvcjogRXJyb3IgfCBudWxsKSA9PiB2b2lkKTogdm9pZFxuXHR7XG5cdFx0aW50ZXJuYWwuX2Rlc3Ryb3kodGhpcywgZXJyb3IsIGNhbGxiYWNrKVxuXHR9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVTeW5jUmVhZFN0cmVhbShwYXRoOiBQYXRoTGlrZSwgb3B0aW9ucz86IHN0cmluZyB8IElGc1JlYWRTdHJlYW1PcHRpb25zKVxue1xuXHRyZXR1cm4gbmV3IFN5bmNSZWFkU3RyZWFtKHBhdGgsIG9wdGlvbnMpXG59XG5cbmV4cG9ydCBkZWZhdWx0IFN5bmNSZWFkU3RyZWFtXG4vLyBAdHMtaWdub3JlXG5PYmplY3QuZnJlZXplKGV4cG9ydHMpXG4iXX0=